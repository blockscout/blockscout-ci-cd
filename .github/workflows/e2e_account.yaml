name: E2E K8s account

on:
  # push:
  workflow_dispatch:

env:
  K8S_LOCAL_PORT: ${{ secrets.K8S_LOCAL_PORT }}
  K8S_HOST: ${{ secrets.K8S_HOST }}
  BASTION_HOST: ${{ secrets.BASTION_HOST }}
  K8S_PORT: ${{ secrets.K8S_PORT }}
  USERNAME: ${{ secrets.USERNAME }}
  BASTION_SSH_KEY: ${{secrets.BASTION_SSH_KEY}}

jobs:
  deploy_bs_stack:
    uses: blockscout/blockscout-ci-cd/.github/workflows/deploy.yaml@master
    with:
      valuesDir: charts/blockscout-stack/values/e2e-account
      appNamespace: e2e-test-account
      appName: e2e-bs-stack
    secrets: inherit
  test:
    name: Test E2E contract interaction
    runs-on: ubuntu-latest
    steps:
    - name: Collect Workflow Telemetry
      uses: runforesight/foresight-workflow-kit-action@v1
      with:
        api_key: ${{ secrets.THUNDRA_APIKEY }}
    - name: checkout
      uses: actions/checkout@v2
      with:
        repository: blockscout/blockscout-ci-cd
        path: blockscout-ci-cd
    - name: Setup node
      uses: actions/setup-node@v3
      with:
        node-version: v14.17.0
    - name: Build contracts
      working-directory: blockscout-ci-cd/tests/contracts
      run: |
        # gyp build from root
        npm config set user 0
        npm ci
        npm run build
    - name: Cache playwright binaries
      uses: actions/cache@v2
      id: playwright-cache
      with:
        path: |
          ~/.cache/ms-playwright
        key: ${{ runner.os }}-build-${{ env.cache-name }}
        restore-keys: ${{ runner.os }}-build-${{ env.cache-name }}
    - name: Install Playwright
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: npx playwright install --with-deps
    - name: Run playwright smoke suite
      run: |
        npm run test:smoke:account
    - name: Run playwright verification suite
      run: |
        npm run test:smoke:verification
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: report
        path: blockscout-ci-cd/tests/e2e/html-report/index.html
    - name: Analyze Test and/or Coverage Results
      uses: runforesight/foresight-test-kit-action@v1
      if: always()
      with:
        api_key: ${{ secrets.THUNDRA_APIKEY }}
        test_format: JUNIT
        test_framework: JEST
        test_path: blockscout-ci-cd/tests/e2e/results.xml
