name: Deploy to k8s
on: [push]

jobs:

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v2
    - name: Set Kubernetes Context
      uses: azure/k8s-set-context@v1
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
    - name: Deploy to k8s
      shell: bash
      env:
        K8S_HOST: ${{ secrets.K8S_HOST }}
        BASTION_HOST: ${{ secrets.BASTION_HOST }}
        K8S_PORT: ${{ secrets.K8S_PORT }}
        LOCAL_PORT: ${{ secrets.LOCAL_PORT }}
        USERNAME: ${{ secrets.USERNAME }}
        BASTION_SSH_KEY: ${{secrets.BASTION_SSH_KEY}}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        mkdir ~/.ssh
        ssh-keyscan -H $BASTION_HOST >> ~/.ssh/known_hosts
        eval `ssh-agent -s`
        ssh-add - <<< "$BASTION_SSH_KEY"
        sudo echo "127.0.0.1 $K8S_HOST" | sudo tee -a /etc/hosts
        ssh -fN -v -L $LOCAL_PORT:$K8S_HOST:$K8S_PORT $USERNAME@$BASTION_HOST
        kubectl get svc
